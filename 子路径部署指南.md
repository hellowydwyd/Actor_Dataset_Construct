# 🌐 阿里云子路径部署指南

## 🎯 目标效果
- **现有项目**: http://灵织.cn/ (主站)
- **人脸识别**: http://灵织.cn/actor/ (子站)
- **API接口**: http://灵织.cn/actor/api/

## 🔧 第一步：修改Flask应用配置

### 1. 创建子路径适配版本

让我为您创建一个支持子路径的Flask应用配置：

```python
# 文件：web/app_subpath.py
from flask import Flask, request
import os

def create_app_with_subpath(subpath='/actor'):
    """创建支持子路径的Flask应用"""
    app = Flask(__name__)
    app.config['APPLICATION_ROOT'] = subpath
    
    # 注册所有蓝图和路由...
    
    return app
```

### 2. 修改静态文件路径

需要确保所有静态文件(CSS/JS/图片)都使用相对路径或绝对路径：

```html
<!-- 修改前 -->
<link href="/static/css/main.css" rel="stylesheet">

<!-- 修改后 -->
<link href="/actor/static/css/main.css" rel="stylesheet">
```

## 🔧 第二步：配置Nginx反向代理

### 1. 创建Nginx配置文件

在服务器上创建 `/etc/nginx/sites-available/multi-projects`：

```nginx
server {
    listen 80;
    server_name 灵织.cn 114.215.208.180;
    
    # 主项目（现有项目）
    location / {
        # 假设您的现有项目运行在3000端口
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 人脸识别系统子路径
    location /actor/ {
        # 注意末尾的斜杠很重要
        proxy_pass http://127.0.0.1:5000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 处理大文件上传
        client_max_body_size 100M;
        proxy_request_buffering off;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
    
    # API接口专门配置
    location /actor/api/ {
        proxy_pass http://127.0.0.1:5000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # API专用配置
        proxy_buffering off;
        proxy_cache off;
    }
    
    # 静态文件直接代理
    location /actor/static/ {
        proxy_pass http://127.0.0.1:5000/static/;
        proxy_set_header Host $host;
        
        # 静态文件缓存
        expires 1d;
        add_header Cache-Control "public, immutable";
    }
}
```

### 2. 启用配置

```bash
# 1. 保存配置文件
sudo nano /etc/nginx/sites-available/multi-projects

# 2. 创建软链接
sudo ln -s /etc/nginx/sites-available/multi-projects /etc/nginx/sites-enabled/

# 3. 删除默认配置（如果存在冲突）
sudo rm -f /etc/nginx/sites-enabled/default

# 4. 测试配置
sudo nginx -t

# 5. 重启Nginx
sudo systemctl restart nginx
```

## 🚀 第三步：部署人脸识别系统

### 1. 连接服务器
```bash
ssh root@114.215.208.180
```

### 2. 下载项目
```bash
cd /opt
git clone https://github.com/hellowydwyd/Actor_Dataset_Construct.git
cd Actor_Dataset_Construct
```

### 3. 安装依赖
```bash
# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install -r requirements-china.txt
```

### 4. 配置API密钥
```bash
cp config/env_example .env
nano .env
# 添加: TMDB_API_KEY=486ceb284a5bba2fb9dff62fb2d2c819
```

### 5. 启动应用
```bash
# 方法1: 直接启动（测试用）
python main.py web --host 127.0.0.1 --port 5000

# 方法2: 后台运行
nohup python main.py web --host 127.0.0.1 --port 5000 > actor.log 2>&1 &

# 方法3: 使用systemd服务（推荐）
# 参考上面创建的 actor-recognition.service
```

## 🌐 第四步：验证部署结果

### 访问测试
```bash
# 1. 测试现有项目
curl -I http://灵织.cn/

# 2. 测试人脸识别系统
curl -I http://灵织.cn/actor/

# 3. 测试API接口
curl -I http://灵织.cn/actor/api/database_stats
```

### 预期结果
```bash
✅ http://灵织.cn/          → 您的现有项目
✅ http://灵织.cn/actor/    → 人脸识别系统首页
✅ http://灵织.cn/actor/api/ → 人脸识别API
```

## 🔧 第五步：处理可能的问题

### 问题1: 静态文件404
**原因**: 静态文件路径不匹配
**解决**: 修改Flask模板中的静态文件路径

### 问题2: API路径错误
**原因**: JavaScript中的API路径需要调整
**解决**: 将API路径改为 `/actor/api/`

### 问题3: 现有项目冲突
**原因**: Nginx配置冲突
**解决**: 调整location块的优先级

## 💡 优化建议

### 性能优化
```nginx
# 在Nginx配置中添加
location /actor/static/ {
    proxy_pass http://127.0.0.1:5000/static/;
    expires 7d;  # 静态文件缓存7天
    gzip on;     # 启用压缩
}
```

### SSL配置（可选）
```nginx
# 如果已有SSL证书
server {
    listen 443 ssl;
    server_name 灵织.cn;
    
    ssl_certificate /path/to/your/cert.pem;
    ssl_certificate_key /path/to/your/key.pem;
    
    # 其他配置保持不变...
}
```

## 📋 部署检查清单

- [ ] ✅ 服务器连接正常
- [ ] ✅ 项目代码已下载
- [ ] ✅ Python依赖已安装
- [ ] ✅ API密钥已配置
- [ ] ✅ Flask应用已启动（端口5000）
- [ ] ✅ Nginx配置已添加
- [ ] ✅ Nginx已重启
- [ ] ✅ 可以通过子路径访问

## 🎉 最终效果

### 用户访问体验
1. 访问 `http://灵织.cn/` → 看到您的现有项目
2. 点击菜单或链接到 `http://灵织.cn/actor/` → 进入人脸识别系统
3. 两个系统独立运行，互不干扰

### 管理优势
- ✅ 统一域名管理
- ✅ 共享SSL证书
- ✅ 资源合理分配
- ✅ 运维成本最低
