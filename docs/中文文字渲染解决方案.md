# OpenCV中文文字渲染解决方案

## 问题描述

OpenCV的`cv2.putText()`函数不支持中文字符显示，在视频人脸识别中绘制中文演员名字时会出现乱码或方块字符。

## 解决方案

### 1. 技术方案

使用PIL(Pillow)库结合系统字体来渲染中文文字，然后将结果合成到OpenCV图像中。

### 2. 实现原理

```python
# 核心流程
1. BGR图像 -> RGB图像 (OpenCV转PIL)
2. 使用PIL + 系统字体绘制中文文字
3. RGB图像 -> BGR图像 (PIL转OpenCV)
```

### 3. 主要特性

- ✅ **自动字体检测**: 自动查找系统中文字体
- ✅ **跨平台支持**: 支持Windows、Linux、macOS
- ✅ **文字背景**: 支持绘制文字背景色
- ✅ **文字描边**: 支持绘制带描边的文字
- ✅ **字体缓存**: 提高性能，避免重复加载字体
- ✅ **尺寸计算**: 准确计算中文文字尺寸
- ✅ **错误处理**: 优雅降级，确保程序稳定运行

## 使用方法

### 基本使用

```python
from src.utils.chinese_text_renderer import draw_chinese_text

# 绘制中文文字
img = draw_chinese_text(
    img=frame,
    text="摩根·弗里曼 (0.95)",
    position=(100, 100),
    font_size=20,
    color=(255, 255, 255),          # 白色文字
    background_color=(0, 0, 255),   # 红色背景
    background_padding=8
)
```

### 带描边文字

```python
from src.utils.chinese_text_renderer import draw_chinese_text_with_outline

# 绘制带描边的中文文字
img = draw_chinese_text_with_outline(
    img=frame,
    text="李雪健 (0.93)",
    position=(100, 150),
    font_size=20,
    text_color=(255, 255, 255),     # 白色文字
    outline_color=(0, 0, 0),        # 黑色描边
    outline_width=2
)
```

## 支持的系统字体

### Windows
- `C:/Windows/Fonts/msyh.ttc` (微软雅黑)
- `C:/Windows/Fonts/simhei.ttf` (黑体)
- `C:/Windows/Fonts/simsun.ttc` (宋体)
- `C:/Windows/Fonts/NotoSansCJK-Regular.ttc` (Noto Sans CJK)

### Linux
- `/usr/share/fonts/truetype/droid/DroidSansFallbackFull.ttf`
- `/usr/share/fonts/truetype/noto/NotoSansCJK-Regular.ttc`
- `/usr/share/fonts/truetype/wqy/wqy-microhei.ttc`
- `/usr/share/fonts/wqy-microhei/wqy-microhei.ttc`

### macOS
- `/System/Library/Fonts/PingFang.ttc` (苹方)
- `/System/Library/Fonts/STHeiti Light.ttc` (华文黑体)
- `/Library/Fonts/Arial Unicode MS.ttf`

## 性能优化

### 1. 字体缓存
```python
# 字体对象会被自动缓存，避免重复加载
font_cache = {}  # 按 "字体路径_字体大小" 缓存
```

### 2. 尺寸预计算
```python
# 提前计算文字尺寸，优化布局
width, height = renderer.get_text_size("文字", font_size=20)
```

### 3. 错误降级
```python
# 如果中文字体加载失败，自动使用默认字体
if font_load_failed:
    font = ImageFont.load_default()
```

## 在视频识别中的应用

### 修改前 (不支持中文)
```python
cv2.putText(frame, actor_name, (x, y), 
           cv2.FONT_HERSHEY_SIMPLEX, 0.6, (255, 255, 255), 2)
# 结果: 中文显示为方块 □□□
```

### 修改后 (支持中文)
```python
frame = draw_chinese_text(
    frame, actor_name, (x, y),
    font_size=18,
    color=(255, 255, 255),
    background_color=actor_color,
    background_padding=8
)
# 结果: 正确显示 "摩根·弗里曼 (0.95)"
```

## 测试验证

### 运行测试脚本
```bash
python scripts/test_chinese_text.py
```

### 测试内容
- 系统字体检测
- 多种中文文字渲染
- 不同颜色和背景组合
- 描边效果测试

### 测试输出
- 控制台显示系统字体路径
- 生成测试图片 `temp/chinese_text_test.jpg`
- 图形界面显示测试结果（如果支持）

## 故障排除

### 1. 中文显示异常
**问题**: 中文仍然显示为方块或乱码
**解决**:
- 检查系统是否安装了中文字体
- 确认字体文件路径是否正确
- 尝试手动指定字体路径

### 2. 字体加载失败
**问题**: 找不到系统字体
**解决**:
```bash
# Windows: 安装微软雅黑字体
# Linux: 安装中文字体包
sudo apt-get install fonts-wqy-microhei fonts-wqy-zenhei

# macOS: 系统通常已包含中文字体
```

### 3. 性能问题
**问题**: 文字渲染速度慢
**解决**:
- 字体会自动缓存，首次加载后性能提升
- 避免频繁改变字体大小
- 考虑预渲染常用文字

### 4. 内存使用
**问题**: 长时间运行内存增长
**解决**:
- 字体缓存有限制，不会无限增长
- PIL图像对象会自动垃圾回收
- 如需要可手动清理缓存

## 兼容性说明

### 已测试环境
- Windows 10/11 + Python 3.8+
- Ubuntu 20.04+ + Python 3.8+
- macOS 12+ + Python 3.8+

### 依赖版本
- `opencv-python >= 4.5.0`
- `Pillow >= 8.0.0`
- `numpy >= 1.20.0`

## 注意事项

1. **坐标系统**: PIL使用(x,y)坐标，与OpenCV一致
2. **颜色格式**: 注意BGR(OpenCV) vs RGB(PIL)的转换
3. **字体版权**: 确保使用的字体符合版权要求
4. **性能考虑**: 视频处理中建议缓存常用字体
5. **错误处理**: 系统已包含完善的错误处理和降级机制

## 扩展功能

### 自定义字体
```python
# 使用自定义字体文件
custom_font_path = "path/to/your/font.ttf"
img = draw_chinese_text(img, text, pos, font_path=custom_font_path)
```

### 多行文字
```python
# 可以通过多次调用实现多行文字
lines = text.split('\n')
for i, line in enumerate(lines):
    y_pos = base_y + i * line_height
    img = draw_chinese_text(img, line, (x, y_pos), ...)
```

### 文字对齐
```python
# 通过计算文字尺寸实现居中对齐
text_width, text_height = renderer.get_text_size(text, font_size)
center_x = (image_width - text_width) // 2
img = draw_chinese_text(img, text, (center_x, y), ...)
```
