# 图片目录结构迁移说明

## 概述

为了更好地组织图片文件，项目已从按演员分类的目录结构迁移到按电影分类的新结构。

## 目录结构变化

### 旧结构（按演员分类）
```
data/images/
├── 123_摩根·弗里曼/
│   ├── 摩根·弗里曼_001.jpg
│   └── 摩根·弗里曼_002.jpg
├── 456_蒂姆·罗宾斯/
│   ├── 蒂姆·罗宾斯_001.jpg
│   └── 蒂姆·罗宾斯_002.jpg
└── aligned_faces/
    └── ...
```

### 新结构（按电影分类）
```
data/images/
├── 肖申克的救赎/
│   ├── 123_摩根·弗里曼/
│   │   ├── 摩根·弗里曼_001.jpg
│   │   └── 摩根·弗里曼_002.jpg
│   └── 456_蒂姆·罗宾斯/
│       ├── 蒂姆·罗宾斯_001.jpg
│       └── 蒂姆·罗宾斯_002.jpg
├── 钢铁侠/
│   ├── 789_小罗伯特·唐尼/
│   │   └── 小罗伯特·唐尼_001.jpg
│   └── 101_格温妮斯·帕特洛/
│       └── 格温妮斯·帕特洛_001.jpg
├── unknown_movie/          # 无法确定电影的演员
│   └── ...
└── aligned_faces/
    └── ...
```

## 优势

1. **按项目组织**: 同一电影的演员图片集中管理
2. **便于管理**: 可以一次性删除整个电影的数据
3. **逻辑清晰**: 符合实际使用场景
4. **扩展性好**: 支持多电影项目管理

## 系统改动

### 1. 图片保存逻辑
- `ImageCrawler.collect_actor_images()` 现在按电影创建目录
- 电影名称会被清理以确保文件系统兼容性
- 支持 `unknown_movie` 目录存放无法确定电影的演员

### 2. 删除功能增强
- `clear_database()` 现在会删除所有电影目录
- `delete_actor()` 会删除空的演员目录和电影目录
- 支持新旧两种目录结构的清理

### 3. 头像查找逻辑
- `find_actor_avatar()` 现在会在所有电影目录中搜索
- 向后兼容旧的目录结构
- 智能搜索确保找到正确的头像

## 迁移工具

### 自动迁移脚本

项目提供了迁移脚本来将现有的图片从旧结构迁移到新结构：

```bash
# 预览迁移（不实际移动文件）
python scripts/migrate_image_structure.py

# 执行实际迁移
python scripts/migrate_image_structure.py --execute
```

### 迁移原理

1. **读取元数据**: 从向量数据库中读取演员与电影的对应关系
2. **计划生成**: 为每个演员目录生成迁移计划
3. **目录创建**: 根据电影名称创建新的目录结构
4. **文件移动**: 将演员目录移动到对应的电影目录下
5. **清理工作**: 删除空的旧目录

### 安全保证

- **预览模式**: 默认只预览，不实际移动文件
- **错误处理**: 迁移过程中的错误会被记录但不会中断整个过程
- **备份建议**: 建议在迁移前备份 `data/images` 目录

## 兼容性

- **向后兼容**: 新系统可以处理旧格式的目录结构
- **渐进迁移**: 新构建的数据集会使用新结构，旧数据保持原样直到迁移
- **双格式支持**: 查找和删除功能同时支持新旧两种格式

## 注意事项

1. **电影名称清理**: 特殊字符会被移除或替换以确保文件系统兼容
2. **未知电影处理**: 无法确定电影的演员会被放入 `unknown_movie` 目录
3. **目录权限**: 确保有足够权限创建和移动目录
4. **磁盘空间**: 迁移过程可能需要额外的临时磁盘空间

## 使用建议

1. **新项目**: 直接使用新的按电影分类的结构
2. **现有项目**: 使用迁移脚本转换到新结构
3. **混合使用**: 系统支持新旧格式共存，可以逐步迁移

## 故障排除

### 常见问题

1. **权限不足**: 确保对 `data/images` 目录有读写权限
2. **特殊字符**: 电影名称中的特殊字符会被自动处理
3. **空目录**: 迁移后的空目录会被自动清理
4. **重复文件**: 系统会避免覆盖已存在的文件

### 恢复方法

如果迁移出现问题，可以：
1. 从备份恢复原始目录结构
2. 检查迁移日志找出具体问题
3. 手动调整有问题的目录
4. 重新运行迁移脚本
