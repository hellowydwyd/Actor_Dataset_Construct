# 🎯 电影演员人脸识别系统 - 核心业务逻辑流程图

## 🏗️ 系统总体核心业务流程

```mermaid
flowchart TB
    Start([系统启动]) --> UserInput{用户操作}
    
    UserInput -->|构建数据集| BuildFlow[数据集构建业务流程]
    UserInput -->|视频识别| VideoFlow[视频识别业务流程]  
    UserInput -->|人脸搜索| SearchFlow[相似度搜索业务流程]
    UserInput -->|Web管理| WebFlow[Web界面业务流程]
    
    BuildFlow --> Database[(人脸向量数据库)]
    VideoFlow --> Database
    SearchFlow --> Database
    WebFlow --> Database
    
    Database --> Results[业务结果输出]
    
    style Start fill:#e3f2fd
    style Database fill:#f3e5f5
    style Results fill:#e8f5e8
    style BuildFlow fill:#fff3e0
    style VideoFlow fill:#fce4ec
    style SearchFlow fill:#f1f8e9
    style WebFlow fill:#e1f5fe
```

## 📊 核心业务流程1：数据集构建

```mermaid
flowchart TD
    A1[用户输入电影名称] --> A2[业务验证]
    A2 --> A3{输入合法?}
    A3 -->|否| A4[返回错误信息]
    A3 -->|是| A5[TMDB API调用]
    
    A5 --> A6[获取电影详情]
    A6 --> A7[提取演员列表]
    A7 --> A8{找到演员?}
    A8 -->|否| A9[返回无演员信息]
    A8 -->|是| A10[多源图片收集业务]
    
    A10 --> A11[TMDB官方图片]
    A10 --> A12[Google图片搜索]
    A10 --> A13[Bing图片搜索]
    
    A11 --> A14[图片下载与去重]
    A12 --> A14
    A13 --> A14
    
    A14 --> A15[图片质量检查]
    A15 --> A16{图片质量合格?}
    A16 -->|否| A17[丢弃低质量图片]
    A16 -->|是| A18[人脸识别业务处理]
    
    A18 --> A19[InsightFace人脸检测]
    A19 --> A20{检测到人脸?}
    A20 -->|否| A21[标记为无效图片]
    A20 -->|是| A22[人脸对齐处理]
    
    A22 --> A23[特征向量提取 512D]
    A23 --> A24[向量归一化]
    A24 --> A25[质量评分计算]
    A25 --> A26[最佳人脸筛选]
    
    A26 --> A27[构建元数据]
    A27 --> A28[向量数据库存储]
    A28 --> A29[Faiss索引更新]
    A29 --> A30[构建完成统计]
    
    A17 --> A14
    A21 --> A14
    A4 --> End([流程结束])
    A9 --> End
    A30 --> End
    
    style A1 fill:#e3f2fd
    style A18 fill:#fff3e0
    style A28 fill:#f3e5f5
    style A30 fill:#e8f5e8
```

## 🎥 核心业务流程2：视频人脸识别

```mermaid
flowchart TD
    B1[用户上传视频文件] --> B2[文件格式验证]
    B2 --> B3{格式支持?}
    B3 -->|否| B4[返回格式错误]
    B3 -->|是| B5[视频解码初始化]
    
    B5 --> B6[获取视频信息]
    B6 --> B7[计算总帧数]
    B7 --> B8[创建输出视频写入器]
    B8 --> B9[开始帧处理循环]
    
    B9 --> B10[读取当前帧]
    B10 --> B11{读取成功?}
    B11 -->|否| B12[处理完成]
    B11 -->|是| B13[人脸检测业务]
    
    B13 --> B14[InsightFace检测]
    B14 --> B15{检测到人脸?}
    B15 -->|否| B16[保持原帧]
    B15 -->|是| B17[人脸特征提取]
    
    B17 --> B18[512D向量生成]
    B18 --> B19[向量归一化]
    B19 --> B20[数据库相似度搜索]
    B20 --> B21[Top-K结果获取]
    
    B21 --> B22{相似度评估}
    B22 -->|≥ 0.6| B23[识别成功]
    B22 -->|< 0.6| B24[未识别]
    
    B23 --> B25[获取角色颜色配置]
    B25 --> B26{有专属颜色?}
    B26 -->|是| B27[使用角色专属颜色]
    B26 -->|否| B28[使用置信度颜色]
    
    B28 --> B29{置信度级别}
    B29 -->|≥ 0.85| B30[绿色-高置信度]
    B29 -->|0.7-0.85| B31[橙色-中等置信度]
    B29 -->|0.6-0.7| B32[黄色-低置信度]
    
    B27 --> B33[根据形状类型绘制人脸框]
    B30 --> B33
    B31 --> B33
    B32 --> B33
    B24 --> B34[绘制灰色人脸框]
    
    B33 --> B35[添加角色/演员姓名标签]
    B34 --> B36[添加Unknown标签]
    
    B35 --> B37[写入标注帧]
    B36 --> B37
    B16 --> B37
    
    B37 --> B38[更新进度信息]
    B38 --> B39{还有下一帧?}
    B39 -->|是| B9
    B39 -->|否| B40[视频处理完成]
    
    B40 --> B41[释放资源]
    B41 --> B42[生成下载链接]
    B42 --> B43[返回处理结果]
    
    B4 --> End([流程结束])
    B12 --> B40
    B43 --> End
    
    style B1 fill:#e3f2fd
    style B13 fill:#fff3e0
    style B20 fill:#f3e5f5
    style B25 fill:#fff8e1
    style B43 fill:#e8f5e8
```

## 🎨 核心业务流程3：颜色管理与人脸框绘制

```mermaid
flowchart TD
    C1[人脸识别结果] --> C2{识别成功?}
    C2 -->|否| C3[使用灰色框标记未知]
    C2 -->|是| C4[获取元数据信息]
    
    C4 --> C5[提取角色名称]
    C5 --> C6[查询角色颜色配置]
    C6 --> C7{找到专属颜色?}
    
    C7 -->|是| C8[使用角色专属颜色]
    C7 -->|否| C9[使用置信度备用颜色]
    
    C8 --> C10[获取颜色配置信息]
    C10 --> C11[color_bgr: 颜色值]
    C10 --> C12[shape_type: 框形类型]
    C10 --> C13[line_thickness: 线条粗细]
    
    C9 --> C14{置信度级别评估}
    C14 -->|≥ 0.85| C15[绿色 - 高置信度]
    C14 -->|0.7-0.85| C16[橙色 - 中等置信度] 
    C14 -->|0.6-0.7| C17[黄色 - 低置信度]
    
    C11 --> C18[根据形状类型绘制]
    C12 --> C18
    C13 --> C18
    C15 --> C19[绘制矩形框]
    C16 --> C19
    C17 --> C19
    
    C18 --> C20{形状类型判断}
    C20 -->|rectangle| C21[绘制矩形框]
    C20 -->|rounded_rectangle| C22[绘制圆角矩形]
    C20 -->|circle| C23[绘制圆形框]
    C20 -->|ellipse| C24[绘制椭圆框]
    C20 -->|diamond| C25[绘制菱形框]
    
    C21 --> C26[添加文字标签]
    C22 --> C26
    C23 --> C26
    C24 --> C26
    C25 --> C26
    C19 --> C26
    C3 --> C27[添加"未知"标签]
    
    C26 --> C28[优先显示角色名称]
    C28 --> C29[备用显示演员名称]
    C29 --> C30[添加相似度分数]
    C27 --> C31[使用白色文字+黑色描边]
    
    C30 --> C32[完成人脸标注]
    C31 --> C32
    
    style C1 fill:#e3f2fd
    style C8 fill:#fff3e0
    style C18 fill:#f3e5f5
    style C32 fill:#e8f5e8
```

### 🎨 颜色管理系统说明

当前系统采用**角色专属颜色优先**的策略：

1. **优先级1：角色专属颜色**
   - 每个角色在数据集构建时分配唯一的颜色和框形
   - 颜色信息存储在 `color_config.json` 中
   - 包含颜色值(BGR)、框形类型、线条粗细等配置

2. **优先级2：置信度备用颜色**
   - 当角色没有专属颜色时，根据识别置信度选择颜色
   - 高置信度(≥0.85)：绿色
   - 中等置信度(0.7-0.85)：橙色  
   - 低置信度(0.6-0.7)：黄色

3. **框形支持**
   - 矩形框(rectangle)
   - 圆角矩形(rounded_rectangle)
   - 圆形框(circle)
   - 椭圆框(ellipse)
   - 菱形框(diamond)

4. **文字标签**
   - 优先显示角色名称
   - 备用显示演员名称
   - 包含相似度分数
   - 使用彩色文字+黑色描边

## 🔍 核心业务流程4：人脸相似度搜索

```mermaid
flowchart TD
    D1[用户上传查询图片] --> D2[图片格式验证]
    D2 --> D3{格式合法?}
    D3 -->|否| D4[返回格式错误]
    D3 -->|是| D5[图片预处理]
    
    D5 --> D6[InsightFace人脸检测]
    D6 --> D7{检测到人脸?}
    D7 -->|否| D8[返回无人脸错误]
    D7 -->|是| D9[选择最佳人脸]
    
    D9 --> D10[人脸对齐处理]
    D10 --> D11[特征向量提取]
    D11 --> D12[向量归一化]
    D12 --> D13[Faiss数据库搜索]
    
    D13 --> D14[计算相似度分数]
    D14 --> D15[Top-K结果排序]
    D15 --> D16[结果过滤]
    D16 --> D17[构建返回数据]
    
    D17 --> D18[添加演员信息]
    D18 --> D19[添加相似度分数]
    D19 --> D20[添加图片路径]
    D20 --> D21[格式化输出结果]
    
    D4 --> End([流程结束])
    D8 --> End
    D21 --> End
    
    style D1 fill:#e3f2fd
    style D6 fill:#fff3e0
    style D13 fill:#f3e5f5
    style D21 fill:#e8f5e8
```

## 🌐 核心业务流程5：Web界面交互

```mermaid
sequenceDiagram
    participant User as 用户
    participant Web as Web前端
    participant API as Flask API
    participant Business as 业务逻辑层
    participant DB as 数据库层
    
    Note over User,DB: Web业务交互流程
    
    User->>Web: 访问系统首页
    Web->>API: GET /api/system_info
    API->>Business: 获取系统状态
    Business->>DB: 查询数据库统计
    DB->>Business: 返回统计信息
    Business->>API: 返回系统状态
    API->>Web: JSON响应
    Web->>User: 显示系统状态
    
    User->>Web: 上传视频文件
    Web->>API: POST /api/process_video
    API->>Business: 调用视频处理业务
    
    loop 视频处理业务循环
        Business->>Business: 帧提取与分析
        Business->>DB: 人脸向量搜索
        DB->>Business: 返回匹配结果
        Business->>API: 更新处理进度
        API->>Web: WebSocket推送进度
        Web->>User: 实时显示进度
    end
    
    Business->>API: 返回处理完成
    API->>Web: 返回下载链接
    Web->>User: 显示结果和下载按钮
    
    User->>Web: 点击下载
    Web->>API: GET /api/download/video_id
    API->>User: 返回视频文件流
```

## 🎯 数据流转核心业务逻辑

```mermaid
flowchart LR
    subgraph Input[输入层]
        I1[电影名称]
        I2[视频文件]
        I3[查询图片]
    end
    
    subgraph Process[业务处理层]
        P1[电影信息获取]
        P2[图片收集处理]
        P3[人脸识别处理]
        P4[向量计算处理]
        P5[相似度匹配]
        P6[结果标注处理]
    end
    
    subgraph Storage[存储层]
        S1[(原始图片存储)]
        S2[(向量数据库)]
        S3[(元数据存储)]
        S4[(处理结果存储)]
    end
    
    subgraph Output[输出层]
        O1[数据集构建报告]
        O2[标注视频文件]
        O3[相似度搜索结果]
        O4[系统统计信息]
    end
    
    I1 --> P1
    I2 --> P3
    I3 --> P3
    
    P1 --> P2
    P2 --> P3
    P3 --> P4
    P4 --> P5
    P5 --> P6
    
    P2 --> S1
    P4 --> S2
    P1 --> S3
    P6 --> S4
    
    S1 --> O1
    S2 --> O2
    S2 --> O3
    S3 --> O4
    
    style Input fill:#e3f2fd
    style Process fill:#fff3e0
    style Storage fill:#f3e5f5
    style Output fill:#e8f5e8
```

## 🔄 系统核心业务状态机

```mermaid
stateDiagram-v2
    [*] --> 系统初始化
    系统初始化 --> 空闲等待
    
    空闲等待 --> 数据集构建中 : 构建请求
    空闲等待 --> 视频处理中 : 视频上传
    空闲等待 --> 搜索处理中 : 搜索请求
    
    数据集构建中 --> 电影信息获取
    电影信息获取 --> 图片收集中
    图片收集中 --> 人脸处理中
    人脸处理中 --> 向量存储中
    向量存储中 --> 构建完成
    构建完成 --> 空闲等待
    
    视频处理中 --> 视频解码中
    视频解码中 --> 帧处理循环
    帧处理循环 --> 人脸识别中
    人脸识别中 --> 相似度匹配中
    相似度匹配中 --> 标注绘制中
    标注绘制中 --> 帧处理循环 : 继续处理
    标注绘制中 --> 视频生成中 : 处理完成
    视频生成中 --> 处理完成
    处理完成 --> 空闲等待
    
    搜索处理中 --> 人脸检测中
    人脸检测中 --> 特征提取中
    特征提取中 --> 数据库搜索中
    数据库搜索中 --> 结果排序中
    结果排序中 --> 搜索完成
    搜索完成 --> 空闲等待
    
    数据集构建中 --> 错误状态 : 构建失败
    视频处理中 --> 错误状态 : 处理失败
    搜索处理中 --> 错误状态 : 搜索失败
    错误状态 --> 空闲等待 : 错误恢复
```
