# 代理配置指南

## 🌐 代理解决方案

### 为什么需要代理？
- 🚫 **IP封锁**: 云服务器IP可能被TMDB限制
- 🛡️ **反爬保护**: TMDB有反爬虫机制
- 🌍 **地理限制**: 某些地区IP访问受限
- 🔄 **网络环境**: 云端网络环境与本地不同

## 🛠️ 代理配置方法

### 方法1: 环境变量配置 (推荐)

在Cloud Studio终端中设置：
```bash
# HTTP代理
export http_proxy=http://proxy-server:port
export https_proxy=http://proxy-server:port

# 或SOCKS5代理
export http_proxy=socks5://proxy-server:port
export https_proxy=socks5://proxy-server:port

# 启动应用
python start_cloudstudio.py
```

### 方法2: Python代码配置

修改 `src/api/tmdb_client.py` 中的请求配置：

```python
import requests
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry

class TMDBClient:
    def __init__(self):
        self.session = requests.Session()
        
        # 配置代理
        proxies = {
            'http': 'http://proxy-server:port',
            'https': 'http://proxy-server:port'
        }
        self.session.proxies.update(proxies)
        
        # 配置重试策略
        retry_strategy = Retry(
            total=3,
            backoff_factor=1,
            status_forcelist=[429, 500, 502, 503, 504],
        )
        adapter = HTTPAdapter(max_retries=retry_strategy)
        self.session.mount("http://", adapter)
        self.session.mount("https://", adapter)
```

### 方法3: 配置文件方式

在 `config/config.yaml` 中添加代理配置：

```yaml
# TMDB API配置
tmdb:
  api_key: "your_api_key"
  base_url: "https://api.themoviedb.org/3"
  
  # 代理配置
  proxy:
    enabled: true
    http_proxy: "http://proxy-server:port"
    https_proxy: "http://proxy-server:port"
    # 或使用SOCKS5
    # http_proxy: "socks5://proxy-server:port"
    # https_proxy: "socks5://proxy-server:port"
  
  # 请求配置
  timeout: 30
  max_retries: 3
  retry_delay: 2
```

然后修改代码读取配置：
```python
def __init__(self):
    self.tmdb_config = config.get_tmdb_config()
    self.proxy_config = self.tmdb_config.get('proxy', {})
    
    self.session = requests.Session()
    
    # 设置代理
    if self.proxy_config.get('enabled', False):
        proxies = {
            'http': self.proxy_config.get('http_proxy'),
            'https': self.proxy_config.get('https_proxy')
        }
        self.session.proxies.update(proxies)
```

## 🔑 **免费代理资源**

### 公共代理服务
1. **免费HTTP代理**:
   - http://proxy-list.org/
   - https://www.proxy-list.download/
   - https://free-proxy-list.net/

2. **免费SOCKS5代理**:
   - https://www.socks-proxy.net/
   - https://sockslist.net/

### 代理验证
```bash
# 测试代理是否可用
curl -x http://proxy-server:port https://api.themoviedb.org/3

# 测试SOCKS5代理
curl --socks5 proxy-server:port https://api.themoviedb.org/3
```

## 🚀 **实用代理方案**

### 推荐配置组合

#### 1. 轮换代理策略
```python
# 多个代理轮换使用
proxy_list = [
    "http://proxy1:port",
    "http://proxy2:port", 
    "http://proxy3:port"
]

import random

def get_random_proxy():
    return {
        'http': random.choice(proxy_list),
        'https': random.choice(proxy_list)
    }

# 在请求中使用
response = requests.get(url, proxies=get_random_proxy())
```

#### 2. 智能降级策略
```python
def _make_request_with_fallback(self, endpoint, params=None):
    """带降级的API请求"""
    
    # 1. 尝试直连
    try:
        return self._make_request_direct(endpoint, params)
    except:
        pass
    
    # 2. 尝试代理
    try:
        return self._make_request_with_proxy(endpoint, params)
    except:
        pass
    
    # 3. 使用备用数据
    return self._get_fallback_data(endpoint, params)
```

## 🔧 **Cloud Studio 特定配置**

### 临时代理设置
```bash
# 在Cloud Studio终端中临时设置
export http_proxy=http://your-proxy:port
export https_proxy=http://your-proxy:port
export no_proxy=localhost,127.0.0.1

# 验证代理设置
echo $http_proxy
echo $https_proxy

# 测试网络连接
curl -x $http_proxy https://api.themoviedb.org/3
```

### 持久化代理设置
```bash
# 将代理配置写入环境文件
cat >> ~/.bashrc << EOF
export http_proxy=http://your-proxy:port
export https_proxy=http://your-proxy:port
EOF

# 重新加载环境
source ~/.bashrc
```

## ⚠️ **注意事项**

### 代理安全性
1. **免费代理风险**: 可能不稳定或不安全
2. **API密钥保护**: 确保代理服务可信
3. **数据隐私**: 注意代理可能记录请求内容

### 性能考虑
1. **延迟增加**: 代理会增加请求延迟
2. **稳定性**: 免费代理可能不稳定
3. **速度限制**: 代理可能有速度限制

## 🎯 **实际操作建议**

### 对于Cloud Studio演示

**最简单的方案**：
```bash
# 1. 找一个免费HTTP代理
# 访问 http://proxy-list.org/ 获取代理地址

# 2. 在Cloud Studio中设置
export http_proxy=http://proxy-ip:proxy-port
export https_proxy=http://proxy-ip:proxy-port

# 3. 测试连接
curl -x $http_proxy https://api.themoviedb.org/3

# 4. 启动应用
python start_cloudstudio.py
```

### 备用方案
如果代理也不稳定，建议：
1. **专注于技术展示**: 重点展示代码架构和界面设计
2. **使用测试数据**: 准备一些测试图片进行现场识别
3. **本地演示**: 在本地环境展示完整功能
4. **录制演示视频**: 提前录制功能演示视频

**记住：即使API不可用，您的项目仍然展示了完整的AI系统架构和技术能力！** 🎉
