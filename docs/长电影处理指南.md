# 长电影处理指南

## 概述

本系统针对长时长电影文件进行了全面优化，支持高效处理2-3小时甚至更长的电影文件，解决了内存溢出、处理速度慢、无法中断恢复等问题。

## 核心特性

### 🎬 智能处理模式

系统会根据视频时长自动选择最优处理模式：

- **标准模式** (≤30分钟): 适用于短视频，全帧处理
- **长视频模式** (30-120分钟): 启用内存优化和智能跳帧
- **并行模式** (>120分钟): 多线程并行处理，适用于长电影

### 🧠 内存管理优化

- **动态内存监控**: 实时监控内存使用率
- **智能垃圾回收**: 自动触发垃圾回收机制
- **分块处理**: 将大视频分块处理，避免内存溢出
- **内存阈值控制**: 可配置最大内存使用率（默认80%）

### ⚡ 智能跳帧算法

根据视频时长动态调整跳帧策略：

```
30分钟以内    → 每帧处理 (跳帧率: 1)
30-90分钟     → 每2帧处理1帧 (跳帧率: 2)  
90-180分钟    → 每3帧处理1帧 (跳帧率: 3)
超过3小时     → 每5帧处理1帧 (跳帧率: 5)
```

### 💾 断点续传功能

- **自动保存检查点**: 每30分钟自动保存处理进度
- **智能恢复**: 程序重启后可从上次中断处继续
- **配置匹配验证**: 确保恢复时配置参数一致

### 🔄 并行处理支持

- **多线程架构**: 支持2-4个工作线程并行处理
- **帧队列管理**: 智能管理帧处理队列
- **顺序保障**: 确保输出视频帧的正确顺序

## 使用方法

### 1. 命令行处理

使用提供的长电影处理脚本：

```bash
# 基本用法
python examples/long_movie_processing.py input_movie.mp4

# 指定输出路径
python examples/long_movie_processing.py input_movie.mp4 -o output_movie.mp4

# 限定电影范围
python examples/long_movie_processing.py input_movie.mp4 -m "钢铁侠"

# 强制使用并行模式
python examples/long_movie_processing.py input_movie.mp4 --mode parallel --max-workers 4

# 调整内存使用率
python examples/long_movie_processing.py input_movie.mp4 --max-memory 0.7

# 禁用断点续传
python examples/long_movie_processing.py input_movie.mp4 --no-checkpoint

# 强制重新开始
python examples/long_movie_processing.py input_movie.mp4 --force-restart
```

### 2. Web界面处理

在Web界面上传视频时，系统会：

1. **自动检测视频时长**
2. **选择最优处理模式**
3. **实时显示处理进度**
4. **支持处理中断和恢复**

Web界面额外支持的参数：
- 处理模式选择
- 并行线程数配置
- 内存使用率设置

### 3. API调用

```python
from src.video_recognition.video_processor import VideoFaceRecognizer

# 创建长视频识别器
recognizer = VideoFaceRecognizer(
    similarity_threshold=0.6,
    movie_title="钢铁侠",  # 可选：限定电影范围
    long_video_mode=True,   # 启用长视频模式
    max_memory_usage=0.8    # 最大内存使用率
)

# 标准处理
results = recognizer.process_video_file(
    video_path="long_movie.mp4",
    output_path="processed_movie.mp4",
    progress_callback=progress_callback,
    resume_from_checkpoint=True
)

# 并行处理（适用于超长电影）
results = recognizer.process_video_with_parallel_frames(
    video_path="very_long_movie.mp4",
    output_path="processed_movie.mp4",
    max_workers=3,
    progress_callback=progress_callback
)
```

## 配置选项

在 `config/config.yaml` 中可以调整长视频处理配置：

```yaml
video_processing:
  # 长视频处理优化
  long_video_mode:
    enabled: true                    # 是否自动启用长视频模式
    auto_detect_threshold: 60        # 自动检测阈值（分钟）
    max_memory_usage: 0.8            # 最大内存使用率
    memory_check_interval: 100       # 内存检查间隔（帧数）
    chunk_size: 300                  # 分块处理大小（帧数）
    checkpoint_interval: 1800        # 检查点保存间隔（秒）
  
  # 智能跳帧策略
  smart_skip:
    enabled: true                    # 是否启用智能跳帧
    strategy: "duration_based"       # 跳帧策略
    max_skip_rate: 5                 # 最大跳帧率
  
  # 并行处理配置
  parallel_processing:
    enabled: true                    # 是否启用并行处理
    max_workers: 2                   # 最大工作线程数
    queue_size_multiplier: 2         # 队列大小倍数
    timeout_seconds: 2.0             # 队列超时时间
```

## 性能优化建议

### 硬件要求

**最低配置**:
- CPU: 4核以上
- RAM: 8GB以上
- 存储: SSD推荐

**推荐配置**:
- CPU: 8核以上
- RAM: 16GB以上
- 存储: NVMe SSD

### 处理策略建议

1. **1-2小时电影**: 使用长视频模式，单线程处理
2. **2-3小时电影**: 使用并行模式，2-3个工作线程
3. **超过3小时**: 使用并行模式，适当提高跳帧率

### 内存优化

- 对于8GB内存系统，设置 `max_memory_usage: 0.6`
- 对于16GB内存系统，设置 `max_memory_usage: 0.8`
- 遇到内存警告时，降低并行线程数

### 处理时间估算

基于一般配置的处理时间估算：

| 视频时长 | 标准模式 | 长视频模式 | 并行模式 |
|---------|---------|-----------|---------|
| 30分钟   | 15-20分钟 | 10-15分钟 | 8-12分钟 |
| 90分钟   | 45-60分钟 | 25-35分钟 | 15-25分钟 |
| 180分钟  | 90-120分钟 | 45-70分钟 | 25-45分钟 |

*实际处理时间取决于视频复杂度、硬件配置和人脸数量*

## 故障排除

### 常见问题

**1. 内存不足错误**
```
解决方案：
- 降低 max_memory_usage 参数
- 减少并行工作线程数
- 启用智能跳帧
- 使用更大内存的机器
```

**2. 处理速度太慢**
```
解决方案：
- 启用并行处理模式
- 适当提高跳帧率
- 限定电影范围识别
- 使用SSD存储
```

**3. 检查点恢复失败**
```
解决方案：
- 检查参数配置是否一致
- 使用 --force-restart 重新开始
- 删除损坏的检查点文件
```

**4. 识别准确率下降**
```
解决方案：
- 降低跳帧率
- 提高相似度阈值
- 使用电影范围限定
- 增加训练数据
```

### 监控指标

处理过程中关注以下指标：

- **内存使用率**: 应保持在设定阈值以下
- **处理速度**: fps (帧每秒)
- **垃圾回收频率**: 频繁GC表示内存压力大
- **识别准确率**: 识别人脸数/检测人脸数

## 高级功能

### 自定义跳帧策略

可以通过修改 `_calculate_smart_skip` 方法实现自定义跳帧策略：

```python
def _calculate_smart_skip(self, fps: float, total_frames: int, current_frame: int) -> int:
    # 基于场景变化的动态跳帧
    # 在镜头切换较少的场景增加跳帧率
    # 在动作场景减少跳帧率
    pass
```

### 质量优先模式

对于重要场景，可以启用质量优先模式：

```python
recognizer = VideoFaceRecognizer(
    similarity_threshold=0.7,  # 提高相似度阈值
    long_video_mode=False,     # 禁用跳帧
    max_memory_usage=0.9       # 允许更高内存使用
)
```

## 总结

长电影处理系统通过智能模式选择、内存优化管理、断点续传机制和并行处理架构，能够高效处理各种时长的电影文件。合理配置参数和选择处理模式，可以在保证识别质量的前提下显著提升处理效率。
